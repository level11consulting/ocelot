# project ocelot

Go to the [wiki](https://github.com/level11consulting/ocelot/wiki) for documentation and architecture.

Ocelot is a distributed CI for running in container orchestration environments. It utilizes Vault, Consul, Postgres and NSQ and comes with a bangin' cli.


Future big wants:
- kuberentes werker nodes that interact with kube api
- vagrant werker nodes
- github integration

## Prometheus exports:
- ocelot_regex_failures
- ocelot_build_clean_failed
- ocelot_docker_api_errors_total
- ocelot_active_builds
- ocelot_build_duration_seconds
- ocelot_build_count_total
- ocelot_received_messages
- ocelot_werker_stream_errors_total
- ocelot_failed_cred
- ocelot_bitbucket_failed_calls
- ocelot_admin_request_proc_time
- ocelot_admin_active_requests
- admin_triggered_builds
- ocelot_recieved_hooks
- ocelot_db_active_requests
- ocelot_db_transaction_duration
- ocelot_db_sqllib_error

# Developers
## Getting started with Vagrant

### Requirements on host
The following tools need to be installed on your host.

* Vagrant
* Virtualbox
  * If you use a different Vagrant provider, you may need to set your `VAGRANT_DEFAULT_PROVIDER` environment variable.
  * See [the Vagrant docs](https://www.vagrantup.com/docs/providers/default.html) for more detail
* Ansible 2.7+

From `deploy` directory:
`vagrant up`

This will start 2 VMs. One for infra, one for ocelot components.
(Tip: Automatically sync code from host environment into VMs with `vagrant rsync-auto` in another terminal window after running `vagrant up`)

The ocelot VM will be at IP: `192.168.12.34`

The infra VM will be at IP: `192.168.56.78`

Infrastructure components run as Docker containers. (docker-compose files in `deploy/infra/`)

* Consul UI: http://192.168.56.78:8500
* Vault UI: http://192.168.56.78:8200 - Default token value: `ocelotdev`
* NSQAdmin UI: http://192.168.56.78:4171
* Postgres: 192.168.56.78:5432 - User name/Database name: `postgres`, Password: `mysecretpassword`

When the Vagrant VMs starts up, it will call use Ansible on your host to instantiate the Infra and Ocelot VMs, and attempt to install the current codebase.


You can ssh into these VMs
`vagrant ssh` & `vagrant ssh ocelot` will result in SSHing into the ocelot VM
`vagrant ssh infra` will SSH into the infra VM

The codebase will be located in `/home/vagrant/go/src/github.com/level11consulting/ocelot`

#### Known issues with Vagrant environment
```
 [WARNING]: Could not match supplied host pattern, ignoring: ocelot
```
* `vagrant up` races on some hosts, and Ansible provisioning fails
  * Workaround: If ocelot + infra VMs are deployed, re-run the Ansible provisioning manually
    1. `vagrant up infra --provision`
    2. `vagrant up ocelot --provision` 
* NSQ is not fully configured for Ocelot operation
  * Workaround: Open up NSQAdmin UI. Create a topic `build` with a channel `werker`
* Ocelot services are not started
  * Workaround: `vagrant ssh` into the VM. Start `admin`, `werker`, `hookhandler` in the foreground.
    * Terminal multiplexers like `screen` or `tmux` are installed, and using either them is strongly suggested.

### Validate connectivity on host
To configure the `ocelot` cli to point at this development instance, you need to set these environment variables:

`export ADMIN_HOST=192.168.12.34`
`export ADMIN_PORT=10000`

## Getting started with Docker
(Needs testing, more detail)
From the root of the repo:
`make docker-base`
`make docker-build`
(Start the infrastructure containers - minimum: nsq, consul, vault, postgres)
`docker-compose up`

## Contributing 

### Interfaces / mocks 

If you update any of the interfaces, you will also have to update the mocks generated by gomock and used for testing. Install [gomock](https://github.com/golang/mock) and then from root run `go generate ./...` 
